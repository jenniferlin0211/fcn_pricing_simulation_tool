<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FCN 專業全功能評價儀表板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: #f4f7f9; margin: 0; padding: 20px; }
        .container { max-width: 1500px; margin: auto; }
        .header { background: #008080; color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 20px; border-radius: 15px; text-align: center; border-top: 6px solid #008080; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .wide-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
        h4 { margin: 15px 0 5px 0; color: #008080; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        label { display: block; margin-top: 10px; font-size: 12px; font-weight: bold; color: #666; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #008080; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; }
        #status { font-size: 13px; margin-top: 12px; padding: 10px; border-radius: 8px; display: none; background: #e6fffa; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>FCN 智能評價分析 - 邏輯嚴謹版</h2></div>

    <div class="main-layout">
        <div class="sidebar">
            <h4>1. 標的設定</h4>
            <input type="text" id="tickers" value="TSM, NVDA, TSLA">
            <h4>2. 產品條件</h4>
            <label>天期 (月)</label><input type="number" id="C8" value="12">
            <label>KO 門檻 (%)</label><input type="number" id="C9" value="100">
            <label>KI 門檻 (%)</label><input type="number" id="C10" value="60">
            <label>Strike (%)</label><input type="number" id="C11" value="75">
            <label>KO Start (月)</label><input type="number" id="C12" value="1">
            <label>KI Type</label>
            <select id="C13">
                <option value="A">美式 (全程觀察)</option>
                <option value="E">歐式 (僅看期末)</option>
            </select>
            <label>無風險利率 (%)</label><input type="number" id="C14" value="4.5">
            <h4>3. 模擬設定</h4>
            <label>模擬次數</label><input type="number" id="idSims" value="1000">
            <label>年化配息 (%)</label><input type="number" id="C16" value="15">
            <button onclick="runWorkflow()">執行精準模擬</button>
            <div id="status"></div>
        </div>

        <div class="content-area">
            <div class="kpi-row">
                <div class="kpi-box"><div>Fair Value</div><div id="vFV" style="font-size:32px; font-weight:bold; color:#008080">--</div></div>
                <div class="kpi-box" style="border-top-color:#ed8936"><div>接股頻次</div><div id="vKI" style="font-size:32px; font-weight:bold; color:#ed8936">--</div></div>
                <div class="kpi-box" style="border-top-color:#38b2ac"><div>平均存續 (月)</div><div id="vDur" style="font-size:32px; font-weight:bold; color:#38b2ac">--</div></div>
                <div class="kpi-box" style="border-top-color:#667eea"><div>年化回報</div><div id="vRet" style="font-size:32px; font-weight:bold; color:#667eea">--</div></div>
            </div>

            <div class="wide-card">
                <h3 style="margin-top:0">情境分佈詳情 (1~14 必須加總 = 總次數)</h3>
                <div style="height: 400px; width: 100%;"><canvas id="scenarioChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
let charts = {};

async function runWorkflow() {
    const status = document.getElementById('status');
    const tickers = document.getElementById('tickers').value.split(',').map(s => s.trim().toUpperCase());
    status.style.display = "block"; status.innerText = "⏳ 正在分析實時波動率...";
    try {
        const allPrices = await Promise.all(tickers.map(t => fetchPrice(t)));
        const analysis = analyzeData(allPrices);
        const results = simulateFCN(analysis);
        updateUI(results);
        status.innerText = "✅ 計算完成";
    } catch (e) {
        status.innerText = "❌ 錯誤: " + e.message;
    }
}

async function fetchPrice(ticker) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`;
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
    const data = await res.json();
    return data.chart.result[0].indicators.adjclose[0].adjclose.filter(p => p !== null);
}

function analyzeData(priceSeries) {
    const n = priceSeries.length;
    const returns = priceSeries.map(s => {
        let r = []; for(let i=1; i<s.length; i++) r.push(Math.log(s[i]/s[i-1])); return r;
    });
    const vols = returns.map(r => {
        const m = r.reduce((a,b)=>a+b,0)/r.length;
        return Math.sqrt(r.reduce((a,b)=>a+Math.pow(b-m,2),0)/(r.length-1)) * Math.sqrt(252);
    });
    const matrix = Array.from({length:n}, (_,i) => Array.from({length:n}, (_,j) => {
        if(i===j) return 1;
        const ri = returns[i], rj = returns[j];
        const mi = ri.reduce((a,b)=>a+b,0)/ri.length, mj = rj.reduce((a,b)=>a+b,0)/rj.length;
        let num=0, d1=0, d2=0;
        for(let k=0; k<ri.length; k++){
            num += (ri[k]-mi)*(rj[k]-mj); d1 += Math.pow(ri[k]-mi,2); d2 += Math.pow(rj[k]-mj,2);
        }
        return num/Math.sqrt(d1*d2);
    }));
    return { matrix, vols, nAssets: n };
}

function simulateFCN(analysis) {
    const tenor = parseInt(document.getElementById('C8').value);
    const ko = parseFloat(document.getElementById('C9').value)/100;
    const ki = parseFloat(document.getElementById('C10').value)/100;
    const strike = parseFloat(document.getElementById('C11').value)/100;
    const koStart = parseInt(document.getElementById('C12').value);
    const kiType = document.getElementById('C13').value;
    const rf = parseFloat(document.getElementById('C14').value)/100;
    const sims = parseInt(document.getElementById('idSims').value);
    const cpn = parseFloat(document.getElementById('C16').value)/100;

    // Cholesky
    const n = analysis.nAssets;
    const L = Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0; i<n; i++) {
        for(let j=0; j<=i; j++) {
            let s = 0; for(let k=0; k<j; k++) s += L[i][k] * L[j][k];
            L[i][j] = (i===j) ? Math.sqrt(Math.max(0, analysis.matrix[i][i]-s)) : (analysis.matrix[i][j]-s)/L[j][j];
        }
    }

    let res = { koCounts: new Array(tenor).fill(0), safe: 0, ki: 0, payoffs: 0, durations: 0, totalSims: sims };

    for(let s=0; s<sims; s++) {
        let S = new Array(n).fill(1.0);
        let wasKI = false, hasKO = false;

        for(let m=0; m<tenor; m++) {
            let days = (m === 0) ? 26 : 21;
            for(let d=0; d<days; d++) {
                let zRaw = Array.from({length:n}, () => {
                    let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
                    return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v);
                });
                for(let i=0; i<n; i++){
                    let zCorr = 0; for(let j=0; j<=i; j++) zCorr += L[i][j] * zRaw[j];
                    S[i] *= Math.exp((rf - 0.5 * analysis.vols[i]**2)*(1/252) + analysis.vols[i]*Math.sqrt(1/252)*zCorr);
                    if(kiType === "A" && S[i] <= ki) wasKI = true;
                }
            }
            // 檢查 KO (必須在 koStart 之後且還沒發生 KO)
            if(!hasKO && (m+1) >= koStart && Math.min(...S) >= ko) {
                res.koCounts[m]++;
                res.payoffs += 100 * (1 + (26+m*21)/252*cpn) * Math.exp(-rf*(26+m*21)/252);
                res.durations += (m+1);
                hasKO = true;
                break; // 提前結束
            }
        }

        // 如果走完天期都沒 KO
        if(!hasKO) {
            res.durations += tenor;
            let worst = Math.min(...S);
            if(kiType === "E" && worst <= ki) wasKI = true;
            
            if(wasKI && worst < strike) {
                res.ki++; // 發生接股 (情境 14)
                res.payoffs += (100 * (tenor*21)/252*cpn + 100*worst/strike) * Math.exp(-rf*1);
            } else {
                res.safe++; // 安全到期 (情境 13)
                res.payoffs += 100 * (1 + (tenor*21)/252*cpn) * Math.exp(-rf*1);
            }
        }
    }
    return res;
}

function updateUI(res) {
    document.getElementById('vFV').innerText = (res.payoffs/res.totalSims).toFixed(2);
    document.getElementById('vKI').innerText = res.ki + " 次";
    document.getElementById('vDur').innerText = (res.durations/res.totalSims).toFixed(1) + "月";
    document.getElementById('vRet').innerText = (((res.payoffs/res.totalSims)-100)/(res.durations/res.totalSims)*12).toFixed(2) + "%";

    if(charts.scene) charts.scene.destroy();
    
    let labels = res.koCounts.map((_, i) => `情境${i+1}\n(${i===0?'1-26':(i*21+6)+'-'+((i+1)*21+5)}天)`);
    labels.push("情境13\n安全到期", "情境14\n發生接股");
    let counts = [...res.koCounts, res.safe, res.ki];

    charts.scene = new Chart(document.getElementById('scenarioChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: counts,
                backgroundColor: labels.map((_, i) => i < res.koCounts.length ? '#4db6ac' : (i === labels.length-2 ? '#1a237e' : '#e53935'))
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                datalabels: { anchor: 'end', align: 'top', color: '#444', font: { weight: 'bold' } },
                legend: { display: false }
            },
            scales: { y: { beginAtZero: true, grid: { display: false } } }
        }
    });
}
</script>
</body>
</html>
