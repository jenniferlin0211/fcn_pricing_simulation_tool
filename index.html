<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>結構型商品模擬分析 (蒙地卡羅)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* 基礎樣式 */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: #f0f4f7; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; }
        
        /* 頁首 */
        .header { background: #008080; color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* 版面配置 */
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        
        /* 側邊欄樣式 */
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; }
        h4 { margin: 15px 0 5px 0; color: #008080; border-bottom: 2px solid #e6f2f2; padding-bottom: 5px; }
        label { display: block; margin-top: 10px; font-size: 13px; font-weight: bold; color: #666; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* 按鈕樣式 */
        button { width: 100%; padding: 15px; background: #008080; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 25px; transition: 0.3s; }
        button:hover { background: #006666; }
        
        /* KPI 卡片區 */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 25px; border-radius: 15px; text-align: center; border-top: 6px solid #008080; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .kpi-label { color: #888; font-size: 14px; margin-bottom: 5px; }
        .kpi-value { font-size: 32px; font-weight: bold; color: #008080; }

        /* 圖表區 */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* 狀態提示 */
        #status { font-size: 13px; margin-top: 15px; padding: 10px; border-radius: 8px; display: none; line-height: 1.5; }
        .loading { background: #e6fffa; border: 1px solid #b2f5ea; color: #2c7a7b; }
        .error { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>結構型商品模擬分析 (蒙地卡羅)</h2></div>

    <div class="main-layout">
        <div class="sidebar">
            <h4>1. 標的設定</h4>
            <label>代碼 (逗號隔開, 如 TSM, NVDA)</label>
            <input type="text" id="tickers" value="TSM, NVDA, AAPL">
            
            <h4>2. 產品條件</h4>
            <label>天期 (月)</label>
            <input type="number" id="C8" value="12">
            <label>年化配息 (%)</label>
            <input type="number" id="C16" value="15">
            <label>KO 門檻 (%)</label>
            <input type="number" id="C9" value="100">
            <label>KI 門檻 (%)</label>
            <input type="number" id="C10" value="60">
            <label>Strike (%)</label>
            <input type="number" id="C11" value="75">
            <label>KO Start (月)</label>
            <input type="number" id="C12" value="1">
            <label>KI 形式</label>
            <select id="C13">
                <option value="A">美式 (全程)</option>
                <option value="E">歐式 (期末)</option>
            </select>
            
            <h4>3. 模擬設定</h4>
            <label>無風險利率 (%)</label>
            <input type="number" id="C14" value="4.5">
            <label>模擬次數</label>
            <input type="number" id="idSims" value="1000">
            
            <button onclick="runWorkflow()">執行蒙地卡羅模擬</button>
            <div id="status"></div>
        </div>

        <div class="content-area">
            <div class="kpi-row">
                <div class="kpi-box">
                    <div class="kpi-label">Fair Value (%)</div>
                    <div id="vFV" class="kpi-value">--</div>
                </div>
                <div class="kpi-box" style="border-top-color: #38b2ac;">
                    <div class="kpi-label">平均存續期間 (天數)</div>
                    <div id="vDur" class="kpi-value" style="color: #38b2ac;">--</div>
                </div>
            </div>

            <div class="card">
                <h3>情境分佈詳情</h3>
                <div style="height: 350px;"><canvas id="scenarioChart"></canvas></div>
            </div>

            <div class="viz-grid">
                <div class="card">
                    <h3>相關係數矩陣</h3>
                    <div id="matrixTable" style="margin-top:20px;"></div>
                </div>
                <div class="card">
                    <h3>接股風險貢獻</h3>
                    <div style="height: 300px;"><canvas id="riskChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
let charts = {};

// 1. 下載 Yahoo 數據 (透過 CORS 代理)
async function fetchYahooData(ticker) {
    const period2 = Math.floor(Date.now() / 1000);
    const period1 = period2 - (365 * 24 * 60 * 60);
    const url = `https://query1.finance.yahoo.com/v7/finance/download/${ticker}?period1=${period1}&period2=${period2}&interval=1d&events=history`;
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error(`${ticker} 連線失敗`);
    const json = await response.json();
    const rows = json.contents.trim().split('\n').slice(1);
    return rows.map(r => parseFloat(r.split(',')[4])).filter(p => !isNaN(p));
}

// 2. 分析數據 (波動率與相關係數)
function analyzeData(allPrices) {
    const n = allPrices.length;
    const returns = allPrices.map(prices => {
        let r = [];
        for (let i = 1; i < prices.length; i++) {
            r.push(Math.log(prices[i] / prices[i-1]));
        }
        return r;
    });

    const vols = returns.map(r => {
        const mean = r.reduce((a, b) => a + b, 0) / r.length;
        const variance = r.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (r.length - 1);
        return Math.sqrt(variance * 252);
    });

    const matrix = Array.from({ length: n }, (_, i) => 
        Array.from({ length: n }, (_, j) => {
            if (i === j) return 1;
            const r1 = returns[i], r2 = returns[j];
            const len = Math.min(r1.length, r2.length);
            const m1 = r1.reduce((a,b)=>a+b,0)/len, m2 = r2.reduce((a,b)=>a+b,0)/len;
            let num = 0, den1 = 0, den2 = 0;
            for (let k = 0; k < len; k++) {
                num += (r1[k]-m1)*(r2[k]-m2);
                den1 += Math.pow(r1[k]-m1, 2);
                den2 += Math.pow(r2[k]-m2, 2);
            }
            return num / Math.sqrt(den1 * den2);
        })
    );
    return { vols, matrix, n };
}

// 3. 蒙地卡羅模擬
function simulate(stats) {
    const sims = parseInt(document.getElementById('idSims').value);
    const tenor = parseInt(document.getElementById('C8').value);
    const cpn = parseFloat(document.getElementById('C16').value) / 100;
    const ko = parseFloat(document.getElementById('C9').value) / 100;
    const ki = parseFloat(document.getElementById('C10').value) / 100;
    const strike = parseFloat(document.getElementById('C11').value) / 100;
    const rf = parseFloat(document.getElementById('C14').value) / 100;
    const kiType = document.getElementById('C13').value;
    
    // Cholesky 分解
    const L = Array.from({length: stats.n}, () => Array(stats.n).fill(0));
    for (let i = 0; i < stats.n; i++) {
        for (let j = 0; j <= i; j++) {
            let s = 0;
            for (let k = 0; k < j; k++) s += L[i][k] * L[j][k];
            if (i === j) {
                L[i][j] = Math.sqrt(Math.max(0, stats.matrix[i][i] - s));
            } else {
                L[i][j] = (1.0 / L[j][j] * (stats.matrix[i][j] - s));
            }
        }
    }

    let results = { payoffs: 0, durations: 0, koCounts: new Array(12).fill(0), safe: 0, ki: 0, kiAssetCounts: new Array(stats.n).fill(0) };

    for (let i = 0; i < sims; i++) {
        let S = new Array(stats.n).fill(1.0);
        let hasKO = false, hasKI = false;
        let dayKO = 0;

        for (let t = 1; t <= tenor * 21; t++) {
            let z = Array.from({length: stats.n}, () => {
                let u=Math.random(), v=Math.random();
                return Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
            });
            
            let worstIdx = 0;
            for (let j = 0; j < stats.n; j++) {
                let dz = 0;
                for (let k = 0; k <= j; k++) dz += L[j][k] * z[k];
                S[j] *= Math.exp((rf - 0.5 * Math.pow(stats.vols[j], 2)) * (1/252) + stats.vols[j] * Math.sqrt(1/252) * dz);
                if (S[j] < S[worstIdx]) worstIdx = j;
            }

            if (kiType === 'A' && S.every(v => v <= ki)) hasKI = true;
            
            if (t % 21 === 0 && t >= 21) {
                if (S.every(v => v >= ko)) {
                    hasKO = true; dayKO = t;
                    results.koCounts[Math.floor(t/21)-1]++;
                    results.payoffs += (100 + (t/252)*cpn*100) * Math.exp(-rf * t/252);
                    results.durations += t;
                    break;
                }
            }
        }

        if (!hasKO) {
            results.durations += tenor * 21;
            let worstS = Math.min(...S);
            if (kiType === 'E' && worstS <= ki) hasKI = true;
            
            if (hasKI && worstS < strike) {
                results.ki++;
                results.kiAssetCounts[S.indexOf(worstS)]++;
                results.payoffs += (worstS / strike * 100 + (tenor*21/252)*cpn*100) * Math.exp(-rf * tenor * 21/252);
            } else {
                results.safe++;
                results.payoffs += (100 + (tenor*21/252)*cpn*100) * Math.exp(-rf * tenor * 21/252);
            }
        }
    }
    return results;
}

// 4. 更新介面
function updateUI(tickers, results) {
    const sims = parseInt(document.getElementById('idSims').value);
    document.getElementById('vFV').innerText = (results.payoffs / sims).toFixed(2);
    document.getElementById('vDur').innerText = (results.durations / sims).toFixed(0);

    // 情境圖表
    if (charts.scene) charts.scene.destroy();
    charts.scene = new Chart(document.getElementById('scenarioChart'), {
        type: 'bar',
        data: {
            labels: [...results.koCounts.map((_,i)=>`M${i+1} KO`), '安全', '接股'],
            datasets: [{ data: [...results.koCounts, results.safe, results.ki], backgroundColor: '#4db6ac' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 接股風險圖
    if (charts.risk) charts.risk.destroy();
    charts.risk = new Chart(document.getElementById('riskChart'), {
        type: 'bar',
        data: {
            labels: tickers,
            datasets: [{ data: results.kiAssetCounts.map(c => (c/sims*100).toFixed(1)), backgroundColor: '#e53935' }]
        },
        options: { indexAxis: 'y', responsive: true, plugins: { datalabels: { anchor:'end', align:'right', formatter: v => v+'%' } } }
    });
}

// 執行工作流
async function runWorkflow() {
    const status = document.getElementById('status');
    const tickerList = document.getElementById('tickers').value.split(',').map(s => s.trim().toUpperCase());
    
    status.style.display = 'block';
    status.className = 'loading';
    status.innerText = '⏳ 正在抓取 Yahoo 數據並計算...';

    try {
        const allPrices = await Promise.all(tickerList.map(t => fetchYahooData(t)));
        const stats = analyzeData(allPrices);
        const results = simulate(stats);
        updateUI(tickerList, results);
        status.innerText = '✅ 模擬完成！';
    } catch (e) {
        status.className = 'error';
        status.innerText = '❌ 失敗: ' + e.message + ' (可能是公司擋住了代理請求)';
    }
}
</script>
</body>
</html>
