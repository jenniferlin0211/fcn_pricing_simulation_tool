<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FCN å°ˆæ¥­å…¨åŠŸèƒ½è©•åƒ¹å„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1440px; margin: auto; }
        .header { background: #008080; color: white; padding: 18px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: fit-content; }
        .content-area { display: flex; flex-direction: column; gap: 20px; }
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .kpi-box { background: white; padding: 20px; border-radius: 15px; text-align: center; border-top: 6px solid #008080; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .wide-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .viz-card { background: white; padding: 20px; border-radius: 15px; min-height: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h4 { margin: 15px 0 5px 0; color: #008080; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        label { display: block; margin-top: 10px; font-size: 12px; font-weight: bold; color: #666; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 15px; background: #008080; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        button:hover { background: #006666; transform: scale(1.01); }
        #status { font-size: 13px; margin-top: 12px; padding: 12px; border-radius: 8px; display: none; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0">FCN æ™ºèƒ½é›²ç«¯åˆ†æå„€è¡¨æ¿</h2>
        <div id="vTag">v6.2 Stable | Time-Series Analytics</div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <h4>1. æ¨™çš„è¨­å®š</h4>
            <label>è‚¡ç¥¨ä»£è™Ÿ</label>
            <input type="text" id="tickers" value="TSM, NVDA, TSLA">
            <h4>2. ç”¢å“æ¢ä»¶</h4>
            <label>å¤©æœŸ (æœˆ)</label><input type="number" id="C8" value="12">
            <label>KO é–€æª» (%)</label><input type="number" id="C9" value="100">
            <label>KI é–€æª» (%)</label><input type="number" id="C10" value="60">
            <label>Strike (%)</label><input type="number" id="C11" value="75">
            <label>ä¿éšœæœŸ (æœˆ)</label><input type="number" id="C12" value="1">
            <label>KI å½¢å¼</label>
            <select id="C13"><option value="A">ç¾å¼ (å…¨ç¨‹)</option><option value="E">æ­å¼ (åˆ°æœŸ)</option></select>
            <label>ç„¡é¢¨éšªåˆ©ç‡ (%)</label><input type="number" id="C14" value="4.5" step="0.1">
            <h4>3. æ¨¡æ“¬è¨­å®š</h4>
            <label>æ¨¡æ“¬æ¬¡æ•¸</label><input type="number" id="C15" value="3000">
            <label>å¹´åŒ–é…æ¯ (%)</label><input type="number" id="C16" value="15">
            <button onclick="runWorkflow()">é–‹å§‹åˆ†æä¸¦æ¨¡æ“¬</button>
            <div id="status"></div>
        </div>

        <div class="content-area">
            <div class="kpi-row">
                <div class="kpi-box"><div>Fair Value</div><div id="vFV" style="font-size:32px; font-weight:bold; color:#008080">--</div></div>
                <div class="kpi-box" style="border-top-color:#ed8936"><div>æ¥è‚¡æ©Ÿç‡</div><div id="vKI" style="font-size:32px; font-weight:bold; color:#ed8936">--</div></div>
                <div class="kpi-box" style="border-top-color:#38b2ac"><div>å­˜çºŒæœŸ (æœˆ)</div><div id="vDur" style="font-size:32px; font-weight:bold; color:#38b2ac">--</div></div>
                <div class="kpi-box" style="border-top-color:#667eea"><div>é æœŸå¹´å›å ±</div><div id="vRet" style="font-size:32px; font-weight:bold; color:#667eea">--</div></div>
            </div>

            <div class="wide-card">
                <h3 style="margin-top:0">å…¨æƒ…å¢ƒæ©Ÿç‡åˆ†ä½ˆ (Time-to-Event Distribution)</h3>
                <div style="height: 320px;"><canvas id="scenarioChart"></canvas></div>
            </div>

            <div class="viz-grid">
                <div class="viz-card">
                    <h3 style="color:#008080">ç›¸é—œä¿‚æ•¸ç†±åœ– (Correlation Matrix)</h3>
                    <div id="heatmap" style="height:350px;"></div>
                </div>
                <div class="viz-card">
                    <h3 style="color:#e53935">æ¥è‚¡é¢¨éšªè²¢ç» % (Risk Weighting)</h3>
                    <div style="height:320px;"><canvas id="riskChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};

async function runWorkflow() {
    const status = document.getElementById('status');
    const tickers = document.getElementById('tickers').value.split(',').map(s => s.trim().toUpperCase());
    status.style.display = "block";
    status.style.background = "#e6fffa";
    status.innerText = "â³ æ­£åœ¨å¾ Yahoo Finance ç²å–å³æ™‚æ•¸æ“š...";

    try {
        const allPrices = await Promise.all(tickers.map(t => fetchPrice(t)));
        status.innerText = "ğŸ“‰ æ•¸æ“šç²å–æˆåŠŸï¼Œé–‹å§‹è¨ˆç®—çŸ©é™£èˆ‡é€²è¡Œè’™åœ°å¡ç¾…æ¨¡æ“¬...";
        
        const analysis = analyzeData(allPrices);
        const results = simulateFCN(analysis);
        
        if (!results) throw new Error("æ¨¡æ“¬è¨ˆç®—å¤±æ•—");
        
        updateUI(tickers, analysis, results);
        status.style.background = "#f0fff4";
        status.innerText = "âœ… åˆ†æå®Œæˆï¼æ‰€æœ‰æ•¸æ“šå·²æ›´æ–°ã€‚";
    } catch (e) {
        status.style.background = "#fff5f5";
        status.innerText = "âŒ éŒ¯èª¤: " + e.message;
        console.error("Workflow Error:", e);
    }
}

async function fetchPrice(ticker) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`;
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
    if(!res.ok) throw new Error(`${ticker} æ•¸æ“šç²å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä»£è™Ÿ`);
    const data = await res.json();
    return data.chart.result[0].indicators.adjclose[0].adjclose.filter(p => p !== null);
}

// åŸºç¤çµ±è¨ˆå·¥å…·
const stats = {
    mean: arr => arr.reduce((a, b) => a + b, 0) / arr.length,
    std: arr => {
        const m = stats.mean(arr);
        return Math.sqrt(arr.reduce((a, b) => a + Math.pow(b - m, 2), 0) / (arr.length - 1));
    },
    corr: (x, y) => {
        const mx = stats.mean(x), my = stats.mean(y);
        let num = 0, dx2 = 0, dy2 = 0;
        for (let i = 0; i < x.length; i++) {
            const dx = x[i] - mx, dy = y[i] - my;
            num += dx * dy; dx2 += dx * dx; dy2 += dy * dy;
        }
        return num / Math.sqrt(dx2 * dy2);
    }
};

function rndNormal() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function analyzeData(priceSeries) {
    const n = priceSeries.length;
    let returns = priceSeries.map(s => {
        let r = [];
        for(let i=1; i<s.length; i++) r.push(Math.log(s[i]/s[i-1]));
        return r;
    });
    let vols = returns.map(r => stats.std(r) * Math.sqrt(252));
    let matrix = Array.from({length:n}, (_,i) => Array.from({length:n}, (_,j) => i===j ? 1 : stats.corr(returns[i], returns[j])));
    return { matrix, vols, nAssets: n };
}

function simulateFCN(analysis) {
    const tenor = parseInt(document.getElementById('C8').value) || 12;
    const ko = parseFloat(document.getElementById('C9').value)/100;
    const ki = parseFloat(document.getElementById('C10').value)/100;
    const strike = parseFloat(document.getElementById('C11').value)/100;
    const guard = parseInt(document.getElementById('C12').value) || 1;
    const kiType = document.getElementById('C13').value;
    const rf = parseFloat(document.getElementById('C14').value)/100;
    const sims = parseInt(document.getElementById('C15').value) || 3000;
    const cpn = parseFloat(document.getElementById('C16').value)/100;

    const L = cholesky(analysis.matrix);
    const dt = 1/252;
    
    let totalPayoff = 0, kiCount = 0, totalDur = 0;
    let kiCounters = Array(analysis.nAssets).fill(0);
    let monthlyKO = Array(tenor + 1).fill(0); 
    let finalRedemption = 0, finalKI = 0;

    for(let s=0; s<sims; s++) {
        let S = Array(analysis.nAssets).fill(1.0);
        let isKO = false, wasKI = false;
        let koMonth = -1;

        for(let m=1; m<=tenor; m++) {
            for(let d=1; d<=21; d++) {
                let zRaw = Array.from({length: analysis.nAssets}, () => rndNormal());
                let zCorr = Array(analysis.nAssets).fill(0);
                for(let i=0; i<analysis.nAssets; i++) {
                    for(let j=0; j<=i; j++) zCorr[i] += L[i][j] * zRaw[j];
                    S[i] *= Math.exp((rf - 0.5 * analysis.vols[i]**2)*dt + analysis.vols[i]*Math.sqrt(dt)*zCorr[i]);
                    if(kiType === "A" && S[i] <= ki) wasKI = true;
                }
            }
            if(m > guard) {
                if(Math.min(...S) >= ko) {
                    isKO = true; koMonth = m;
                    monthlyKO[m]++;
                    totalPayoff += 100 * (1 + (m*21)/252 * cpn) * Math.exp(-rf * (m*21)/252);
                    break;
                }
            }
        }

        if(!isKO) {
            let worst = Math.min(...S);
            if(kiType === "E" && worst <= ki) wasKI = true;
            if(wasKI && worst < strike) {
                finalKI++; kiCount++;
                kiCounters[S.indexOf(worst)]++;
                totalPayoff += (100*(tenor*21)/252*cpn + 100*worst/strike) * Math.exp(-rf*(tenor*21)/252);
            } else {
                finalRedemption++;
                totalPayoff += 100 * (1 + (tenor*21)/252 * cpn) * Math.exp(-rf*(tenor*21)/252);
            }
        }
        totalDur += (koMonth === -1 ? tenor : koMonth);
    }
    return { fv: totalPayoff/sims, ki: (kiCount/sims)*100, monthlyKO, finalRedemption, finalKI, sims, avgDur: totalDur/sims };
}

function cholesky(m) {
    const n = m.length;
    const l = Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0; i<n; i++) {
        for(let j=0; j<=i; j++) {
            let s = 0;
            for(let k=0; k<j; k++) s += l[i][k] * l[j][k];
            l[i][j] = (i===j) ? Math.sqrt(Math.max(0, m[i][i]-s)) : (m[i][j]-s)/l[j][j];
        }
    }
    return l;
}

function updateUI(tickers, analysis, res) {
    document.getElementById('vFV').innerText = res.fv.toFixed(2);
    document.getElementById('vKI').innerText = res.ki.toFixed(1) + "%";
    document.getElementById('vDur').innerText = res.avgDur.toFixed(1);
    document.getElementById('vRet').innerText = (((res.fv-100)/Math.max(0.1, res.avgDur))*12).toFixed(2) + "%";

    // 1. Teal Heat Map
    Plotly.newPlot('heatmap', [{
        z: analysis.matrix, x: tickers, y: tickers, type: 'heatmap',
        colorscale: [[0, '#e0f2f1'], [0.5, '#4db6ac'], [1, '#008080']],
        text: analysis.matrix.map(row => row.map(v => v.toFixed(2))),
        texttemplate: "%{text}", showscale: true
    }], { margin: {t:0, b:40, l:40, r:0}, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)' });

    // 2. Scenario Timeline Chart (ä¿®å¾© Map å ±éŒ¯é»)
    if(charts.scene) charts.scene.destroy();
    const koData = (res.monthlyKO || []).slice(1);
    let labels = koData.map((_, i) => `${i+1}æœˆ KO`);
    let data = koData.map(v => (v/res.sims*100).toFixed(1));
    let colors = Array(koData.length).fill('#4db6ac');

    labels.push('å®‰å…¨åˆ°æœŸ', 'æ¥è‚¡çµç®—');
    data.push((res.finalRedemption/res.sims*100).toFixed(1), (res.finalKI/res.sims*100).toFixed(1));
    colors.push('#1a237e', '#e53935');

    charts.scene = new Chart(document.getElementById('scenarioChart'), {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderRadius: 5 }] },
        options: { 
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { callback: v => v + '%' }, grid: { color: '#eee' } }, x: { grid: { display: false } } }
        }
    });

    // 3. Risk Bar %
    if(charts.risk) charts.risk.destroy();
    charts.risk = new Chart(document.getElementById('riskChart'), {
        type: 'bar',
        data: {
            labels: tickers,
            datasets: [{
                data: res.kiCounters.map(v => (v/res.sims*100).toFixed(2)),
                backgroundColor: tickers.map(t=>t==='TSLA'?'#ed8936':'#e53935')
            }]
        },
        options: { 
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true, ticks: { callback: v => v + '%' } } }
        }
    });
}
</script>
</body>
</html>
