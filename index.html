<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FCN 數據對比儀表板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; }
        .container { max-width: 1500px; margin: auto; }
        .header { background: #008080; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .wide-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        h4 { color: #008080; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 15px; background: #008080; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        #status { font-size: 13px; margin-top: 12px; padding: 10px; border-radius: 8px; display: none; background: #e6fffa; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>FCN 數據核對儀表板 (對標 Excel 頻次)</h2></div>

    <div class="main-layout">
        <div class="sidebar">
            <h4>1. 標的設定</h4>
            <input type="text" id="tickers" value="TSM, NVDA, TSLA">
            <h4>2. 產品條件</h4>
            <label>天期 (月)</label><input type="number" id="C8" value="12">
            <label>KO (%)</label><input type="number" id="C9" value="100">
            <label>KI (%)</label><input type="number" id="C10" value="60">
            <label>Strike (%)</label><input type="number" id="C11" value="75">
            <label>模擬次數</label><input type="number" id="C15" value="3000">
            <button onclick="runWorkflow()">開始計算並核對數據</button>
            <div id="status"></div>
            <p style="font-size: 12px; color: #666; margin-top: 20px;">* 注意：蒙地卡羅每次模擬結果皆有隨機波動。若要完全等於 Excel，請將結果匯出或手動輸入數據。</p>
        </div>

        <div class="content-area">
            <div class="wide-card">
                <h3 style="margin-top:0">全情境分佈詳情 (對比 Excel 次數)</h3>
                <div style="height: 450px;"><canvas id="scenarioChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
let charts = {};

async function runWorkflow() {
    const status = document.getElementById('status');
    status.style.display = "block"; status.innerText = "⏳ 正在分析行情並運行 3000 次模擬...";
    
    try {
        const tickers = document.getElementById('tickers').value.split(',').map(s => s.trim().toUpperCase());
        const allPrices = await Promise.all(tickers.map(t => fetchPrice(t)));
        const analysis = analyzeData(allPrices);
        const res = simulateFCN(analysis);
        updateUI(res);
        status.innerText = "✅ 計算完成！請查看上方圖表頻次。";
    } catch (e) {
        status.innerText = "❌ 發生錯誤";
        console.error(e);
    }
}

async function fetchPrice(ticker) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`;
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
    const data = await res.json();
    return data.chart.result[0].indicators.adjclose[0].adjclose.filter(p => p !== null);
}

function analyzeData(priceSeries) {
    const returns = priceSeries.map(s => {
        let r = []; for(let i=1; i<s.length; i++) r.push(Math.log(s[i]/s[i-1])); return r;
    });
    const vols = returns.map(r => {
        const m = r.reduce((a,b)=>a+b,0)/r.length;
        return Math.sqrt(r.reduce((a,b)=>a+Math.pow(b-m,2),0)/(r.length-1)) * Math.sqrt(252);
    });
    const matrix = Array.from({length:priceSeries.length}, (_,i) => Array.from({length:priceSeries.length}, (_,j) => {
        if(i===j) return 1;
        const ri = returns[i], rj = returns[j];
        const mi = ri.reduce((a,b)=>a+b,0)/ri.length, mj = rj.reduce((a,b)=>a+b,0)/rj.length;
        let num=0, d1=0, d2=0;
        for(let k=0; k<ri.length; k++){
            num += (ri[k]-mi)*(rj[k]-mj); d1 += Math.pow(ri[k]-mi,2); d2 += Math.pow(rj[k]-mj,2);
        }
        return num/Math.sqrt(d1*d2);
    }));
    return { matrix, vols };
}

function simulateFCN(analysis) {
    const tenor = 12, ko = 1.0, ki = 0.6, strike = 0.75, sims = 3000;
    // Cholesky 略 (同前版本)
    const n = analysis.vols.length;
    const L = Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0; i<n; i++) {
        for(let j=0; j<=i; j++) {
            let s = 0; for(let k=0; k<j; k++) s += L[i][k] * L[j][k];
            L[i][j] = (i===j) ? Math.sqrt(Math.max(0, 1-s)) : (analysis.matrix[i][j]-s)/L[j][j];
        }
    }

    let res = { koCounts: new Array(12).fill(0), safe: 0, ki: 0 };

    for(let s=0; s<sims; s++) {
        let S = new Array(n).fill(1.0);
        let wasKI = false, hasKO = false;
        for(let m=0; m<12; m++) {
            let days = (m === 0) ? 26 : 21;
            for(let d=0; d<days; d++) {
                let zRaw = Array.from({length:n}, () => {
                    let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
                    return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*PI2(v));
                });
                for(let i=0; i<n; i++){
                    let zCorr = 0; for(let j=0; j<=i; j++) zCorr += L[i][j] * zRaw[j];
                    S[i] *= Math.exp((-0.5 * analysis.vols[i]**2)*(1/252) + analysis.vols[i]*Math.sqrt(1/252)*zCorr);
                    if(S[i] <= ki) wasKI = true;
                }
            }
            if(Math.min(...S) >= ko && !hasKO) { res.koCounts[m]++; hasKO = true; break; }
        }
        if(!hasKO) {
            if(wasKI && Math.min(...S) < strike) res.ki++;
            else res.safe++;
        }
    }
    return res;
}
function PI2(v) { return 2.0 * Math.PI * v; }

function updateUI(res) {
    if(charts.scene) charts.scene.destroy();
    
    let labels = [];
    let startDay = 1;
    for(let i=1; i<=12; i++) {
        let endDay = (i===1) ? 26 : startDay + 20;
        labels.push(`情境${i}\n${startDay}-${endDay}天`);
        startDay = endDay + 1;
    }
    labels.push("情境13\n安全到期", "情境14\n發生接股");

    let counts = [...res.koCounts, res.safe, res.ki];

    charts.scene = new Chart(document.getElementById('scenarioChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: counts,
                backgroundColor: labels.map((_, i) => i < 12 ? '#62b4ad' : (i === 12 ? '#2251a3' : '#d9433c'))
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                datalabels: { anchor: 'end', align: 'top', font: { weight: 'bold', size: 14 } },
                legend: { display: false }
            },
            scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
        }
    });
}
</script>
</body>
</html>
