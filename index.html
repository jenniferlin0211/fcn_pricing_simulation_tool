<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FCN 專業雲端評價引擎</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { background: #1a237e; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .grid-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-top: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .kpi-card { border-top: 6px solid #1a237e; text-align: center; padding: 15px; margin-bottom: 10px; }
        label { display: block; font-size: 13px; color: #666; margin-top: 10px; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #1a237e; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th { background: #455A64; color: white; padding: 8px; }
        td { border: 1px solid #eee; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>FCN 多標的結構型商品模擬</h1></div>

    <div class="grid-layout">
        <div class="panel">
            <h3>輸入參數 (C8:C16)</h3>
            <label>天期 (月) (C8)</label><input type="number" id="C8" value="12">
            <label>KO 門檻 (%) (C9)</label><input type="number" id="C9" value="100">
            <label>KI 門檻 (%) (C10)</label><input type="number" id="C10" value="75">
            <label>Strike (%) (C11)</label><input type="number" id="C11" value="100">
            <label>保障期 (月) (C12)</label><input type="number" id="C12" value="3">
            <label>KI 形式 (A/E) (C13)</label>
            <select id="C13">
                <option value="A">美式 (全程觀察)</option>
                <option value="E">歐式 (到期觀察)</option>
            </select>
            <label>無風險利率 (%) (C14)</label><input type="number" id="C14" value="4.5" step="0.1">
            <label>模擬次數 (C15)</label><input type="number" id="C15" value="5000">
            <label>年化配息 (%) (C16)</label><input type="number" id="C16" value="15">
            
            <button onclick="runFCN()">執行模擬</button>
        </div>

        <div>
            <div style="display:flex; gap:15px">
                <div class="panel kpi-card" style="flex:1"><div>Fair Value (平均報酬)</div><span id="resFV" style="font-size:32px; font-weight:bold; color:#1a237e">--</span>%</div>
                <div class="panel kpi-card" style="flex:1"><div>接股機率</div><span id="resKI" style="font-size:32px; font-weight:bold; color:#e53935">--</span>%</div>
            </div>
            
            <div class="panel" style="margin-top:20px">
                <h3>相關係數與波動率設定 (預設)</h3>
                <p style="font-size:12px; color: #888;">註：雲端版目前預設三標的模擬，相關係數 0.5</p>
                <div id="matrixArea"></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- 核心運算函數 (對應您的 VBA 邏輯) ---

function runFCN() {
    // 讀取 C8:C16
    const tenor = parseInt(document.getElementById('C8').value);
    const koPct = parseFloat(document.getElementById('C9').value) / 100;
    const kiPct = parseFloat(document.getElementById('C10').value) / 100;
    const strikePct = parseFloat(document.getElementById('C11').value) / 100;
    const gMonths = parseInt(document.getElementById('C12').value);
    const kiType = document.getElementById('C13').value;
    const r = parseFloat(document.getElementById('C14').value) / 100;
    const nSims = parseInt(document.getElementById('C15').value);
    const coupon = parseFloat(document.getElementById('C16').value) / 100;

    const nAssets = 3;
    const vols = [0.35, 0.40, 0.30]; // 假設波動率
    const corr = [[1, 0.5, 0.5], [0.5, 1, 0.5], [0.5, 0.5, 1]];
    
    // Cholesky 分解 (對應 InitializeCholesky)
    const L = cholesky(corr);
    
    const totalDays = (21 * tenor) + 5;
    const gDays = (21 * gMonths) + 4;
    const dt = 1 / 252;
    
    let totalPayoff = 0;
    let kiTotalCount = 0;

    for (let s = 0; s < nSims; s++) {
        let sNow = [1.0, 1.0, 1.0];
        let isKO = false;
        let wasKI = false;
        let hasHitKO = [false, false, false];

        for (let t = 1; t <= totalDays; t++) {
            // 生成相關隨機數 (對應 GetCorrelatedRandoms)
            let zRaw = [normSInv(Math.random()), normSInv(Math.random()), normSInv(Math.random())];
            let zCorr = [0, 0, 0];
            for (let i = 0; i < nAssets; i++) {
                for (let j = 0; j <= i; j++) {
                    zCorr[i] += L[i][j] * zRaw[j];
                }
            }

            // GBM 股價演化
            for (let j = 0; j < nAssets; j++) {
                sNow[j] *= Math.exp((r - 0.5 * vols[j]**2) * dt + vols[j] * Math.sqrt(dt) * zCorr[j]);
                if (kiType === "A" && sNow[j] <= kiPct) wasKI = true;
            }

            // KO 觀察 (點名邏輯)
            if (t > gDays) {
                let allHit = true;
                for (let j = 0; j < nAssets; j++) {
                    if (sNow[j] >= koPct) hasHitKO[j] = true;
                    if (!hasHitKO[j]) allHit = false;
                }
                if (allHit) {
                    isKO = true;
                    let p = 100 * (1 + (t-5)/252 * coupon) * Math.exp(-r * t/252);
                    totalPayoff += p;
                    break;
                }
            }
        }

        if (!isKO) {
            let worst = Math.min(...sNow);
            if (kiType === "E" && worst <= kiPct) wasKI = true;
            
            if (wasKI && worst < strikePct) {
                kiTotalCount++;
                let p = (100 * (totalDays-5)/252 * coupon + (100 * worst / strikePct)) * Math.exp(-r * totalDays/252);
                totalPayoff += p;
            } else {
                let p = 100 * (1 + (totalDays-5)/252 * coupon) * Math.exp(-r * totalDays/252);
                totalPayoff += p;
            }
        }
    }

    document.getElementById('resFV').innerText = (totalPayoff / nSims).toFixed(2);
    document.getElementById('resKI').innerText = (kiTotalCount / nSims * 100).toFixed(1);
}

// --- 輔助數學函數 ---
function cholesky(matrix) {
    const n = matrix.length;
    const l = Array.from({ length: n }, () => Array(n).fill(0));
    for (let i = 0; i < n; i++) {
        for (let j = 0; j <= i; j++) {
            let sum = 0;
            for (let k = 0; k < j; k++) sum += l[i][k] * l[j][k];
            if (i === j) l[i][j] = Math.sqrt(matrix[i][i] - sum);
            else l[i][j] = (matrix[i][j] - sum) / l[j][j];
        }
    }
    return l;
}

function normSInv(p) {
    var a = [-3.969683028665376e+01,  2.209460984245205e+02, -2.759285104469687e+02,  1.383577518672690e+02, -3.066479806614716e+01,  2.506628277459239e+00];
    var b = [-5.447609879822406e+01,  1.615858368580409e+02, -1.556989798598866e+02,  6.680131188771972e+01, -1.328068155288572e+01];
    var c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00, -2.549732539343734e+00,  4.374664141464968e+00,  2.938163982698783e+00];
    var d = [7.784695709041462e-03,  3.224671290700398e-01,  2.445134137142996e+00,  3.754408661907416e+00];
    var q, r;
    if (p < 0.02425) {
        q = Math.sqrt(-2*Math.log(p));
        return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
    }
    if (p < 0.97575) {
        q = p - 0.5; r = q*q;
        return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q / (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
    }
    q = Math.sqrt(-2*Math.log(1-p));
    return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
}
</script>
</body>
</html>
