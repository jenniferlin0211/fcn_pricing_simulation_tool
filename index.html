<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN 模擬分析 (API Key 版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        .sidebar { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 320px; float: left; }
        .content { margin-left: 360px; }
        .card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        input { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 16px; background: #008080; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; }
        #status { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; background: #e6fffa; border: 1px solid #b2f5ea; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h3 style="margin:0; color:#008080;">FCN 專業模擬器</h3>
        
        <label style="color:red; font-weight:bold;">1. API Key (必填)</label>
        <input type="text" id="apiKey" placeholder="貼上你的 API Key" value="">
        
        <h4>2. 標的與產品</h4>
        <input type="text" id="tickers" value="TSM,NVDA,TSLA">
        <label>天期 (月)</label><input type="number" id="C8" value="12">
        <label>配息 (%)</label><input type="number" id="C16" value="15">
        <label>KO (%)</label><input type="number" id="C9" value="100">
        <label>KI (%)</label><input type="number" id="C10" value="60">
        <label>Strike (%)</label><input type="number" id="C11" value="75">
        
        <button onclick="runWorkflow()">執行 API 數據分析</button>
        <div id="status"></div>
    </div>

    <div class="content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="card" style="text-align:center;"><div>Fair Value (%)</div><div id="vFV" style="font-size:36px; font-weight:bold; color:#008080">--</div></div>
            <div class="card" style="text-align:center;"><div>平均存續 (天)</div><div id="vDur" style="font-size:36px; font-weight:bold; color:#38b2ac">--</div></div>
        </div>
        <div class="card"><div id="heatmap" style="height: 400px;"></div></div>
    </div>
</div>

<script>
// ✅ 使用 API Key 抓取數據 (以 Twelve Data 為例)
async function fetchPrice(ticker, key) {
    // interval=1day, outputsize=252 (一年交易日)
    const url = `https://api.twelvedata.com/time_series?symbol=${ticker}&interval=1day&outputsize=252&apikey=${key}`;
    
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.status === "ok") {
        // 將數據反轉(由舊到新)並提取收盤價
        return data.values.map(v => parseFloat(v.close)).reverse();
    } else {
        throw new Error(`${ticker} 抓取失敗: ${data.message}`);
    }
}

async function runWorkflow() {
    const key = document.getElementById('apiKey').value;
    const status = document.getElementById('status');
    const tickers = document.getElementById('tickers').value.split(',').map(s => s.trim().toUpperCase());
    
    if (!key) {
        alert("請先輸入 API Key！");
        return;
    }

    status.style.display = "block";
    status.innerText = "⏳ 透過 API 獲取即時數據...";

    try {
        // Twelve Data 免費版可能需要一個一個抓以避免 Rate Limit
        const allPrices = [];
        for (let t of tickers) {
            status.innerText = `⏳ 正在抓取 ${t}...`;
            const p = await fetchPrice(t, key);
            allPrices.push(p);
            // 免費版 API 通常有速度限制，稍微停一下
            await new Promise(r => setTimeout(r, 500));
        }

        status.innerText = "⏳ 數據下載成功，模擬運算中...";
        const analysis = analyzeData(allPrices);
        const results = simulateFCN(analysis);
        updateUI(tickers, analysis, results);
        status.innerText = "✅ 模擬完成";

    } catch (e) {
        status.innerText = "❌ 錯誤: " + e.message;
        console.error(e);
    }
}

// ⚠️ 嚴格多行 If 結構的 FCN 核心邏輯
function analyzeData(priceSeries) {
    const n = priceSeries.length;
    const returns = priceSeries.map(s => {
        let r = [];
        for (let i = 1; i < s.length; i++) {
            r.push(Math.log(s[i] / s[i-1]));
        }
        return r;
    });

    const vols = returns.map(r => {
        const m = r.reduce((a, b) => a + b, 0) / r.length;
        const v = r.reduce((a, b) => a + Math.pow(b - m, 2), 0) / (r.length - 1);
        return Math.sqrt(v) * Math.sqrt(252);
    });

    const matrix = Array.from({ length: n }, (_, i) => Array.from({ length: n }, (_, j) => {
        if (i === j) {
            return 1.0;
        } else {
            const ri = returns[i], rj = returns[j];
            const mi = ri.reduce((a, b) => a + b, 0) / ri.length;
            const mj = rj.reduce((a, b) => a + b, 0) / rj.length;
            let num = 0, d1 = 0, d2 = 0;
            for (let k = 0; k < ri.length; k++) {
                num += (ri[k] - mi) * (rj[k] - mj);
                d1 += Math.pow(ri[k] - mi, 2);
                d2 += Math.pow(rj[k] - mj, 2);
            }
            return num / Math.sqrt(d1 * d2);
        }
    }));
    return { matrix, vols, nAssets: n };
}

function simulateFCN(analysis) {
    const tenor = parseInt(document.getElementById('C8').value);
    const ko = parseFloat(document.getElementById('C9').value)/100;
    const strike = parseFloat(document.getElementById('C11').value)/100;
    const cpn = parseFloat(document.getElementById('C16').value)/100;
    const rf = 0.045, sims = 1000;
    
    const n = analysis.nAssets;
    const L = Array.from({length:n},()=>Array(n).fill(0));
    
    // Cholesky 分解
    for(let i=0; i<n; i++) {
        for(let j=0; j<=i; j++) {
            let s = 0;
            for(let k=0; k<j; k++) { s += L[i][k] * L[j][k]; }
            if (i === j) {
                L[i][j] = Math.sqrt(Math.max(0, analysis.matrix[i][i] - s));
            } else {
                L[i][j] = (analysis.matrix[i][j] - s) / L[j][j];
            }
        }
    }

    let res = { payoffs: 0, durations: 0 };
    const totalDays = 21 * tenor;

    for(let s=0; s<sims; s++) {
        let S = new Array(n).fill(1.0);
        let isKO = false;
        let day = totalDays;

        for(let T=1; T<=totalDays; T++) {
            let zRaw = Array.from({length:n}, () => {
                let u=0, v=0;
                while(u===0) { u=Math.random(); }
                while(v===0) { v=Math.random(); }
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            });

            for(let i=0; i<n; i++) {
                let zCorr = 0;
                for(let j=0; j<=i; j++) { zCorr += L[i][j] * zRaw[j]; }
                S[i] *= Math.exp((rf - 0.5 * analysis.vols[i]**2)*(1/252) + analysis.vols[i]*Math.sqrt(1/252)*zCorr);
            }

            if (T % 21 === 0 && Math.min(...S) >= ko) {
                isKO = true; day = T;
                res.payoffs += 100 * (1 + (T/252)*cpn) * Math.exp(-rf*T/252);
                break;
            }
        }

        if (!isKO) {
            let worst = Math.min(...S);
            if (worst < strike) {
                res.payoffs += (100 * worst / strike) * Math.exp(-rf*totalDays/252);
            } else {
                res.payoffs += 100 * (1 + (totalDays/252)*cpn) * Math.exp(-rf*totalDays/252);
            }
        }
        res.durations += day;
    }
    return res;
}

function updateUI(tickers, analysis, res) {
    const sims = 1000;
    document.getElementById('vFV').innerText = (res.payoffs/sims).toFixed(2);
    document.getElementById('vDur').innerText = (res.durations/sims).toFixed(0);
    
    Plotly.newPlot('heatmap', [{
        z: analysis.matrix, x: tickers, y: tickers, type: 'heatmap',
        colorscale: 'Viridis', text: analysis.matrix.map(row => row.map(v => v.toFixed(2))), texttemplate: "%{text}"
    }], { title: '相關係數驗證', margin: {t:50, b:40, l:40, r:0} });
}
</script>
</body>
</html>
